<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title aria-hidden="true">Admin - Upload Events for Calendar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .upload-section {
            margin: 20px 0;
        }
        input[type="file"] {
            margin-top: 10px;
        }
        button {
            font-size: 16px;
            padding: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>Admin - Upload Events for Calendar</h1>

    <!-- Section for Admin to Upload the Excel File -->
    <div class="upload-section">
        <input type="file" id="fileUpload" />
        <button onclick="uploadEvents()">Upload Events</button>
    </div>
     <button onclick="window.location.href='calendar.html'">Go to Calendar</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    function uploadEvents() {
        const fileUpload = document.getElementById('fileUpload').files[0];
        if (!fileUpload) {
            alert("Please upload a file.");
            return;
        }
       // localStorage.removeItem('calendarEvents'); new line to clear previous events
    function convertExcelTimeToReadable(serialTime) 
    {
    // Multiply by 24 to get the hours portion
        const totalMinutes = Math.round(serialTime * 24 * 60);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;

        // Convert to 12-hour format with AM/PM
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const readableHours = hours % 12 || 12; // Convert 0 to 12 for midnight/noon
        const readableMinutes = minutes.toString().padStart(2, '0');

        return `${readableHours}:${readableMinutes} ${ampm}`;
}


    function excelDateToJSDate(excelDate) {
    // Convert Excel serial number to JavaScript date
    const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
    
    // Get month, day, and year
    const day = String(jsDate.getUTCDate()).padStart(2, '0');
    const month = String(jsDate.getUTCMonth() + 1).padStart(2, '0'); // getUTCMonth() returns 0-indexed months
    const year = jsDate.getUTCFullYear();

    // Return date in mm/dd/yyyy format
    const formattedDate= `${year}-${month}-${day}`;
    console.log(formattedDate);
    return formattedDate;
}

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

             events = {}; 
            //const events = {};

            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                // console.log(row);
                const [date, name, TimeIn, TimeOut] = row;
                const temp_timein=convertExcelTimeToReadable(TimeIn);
                const temp_timeout=convertExcelTimeToReadable(TimeOut);
                const event={
                    name: name,
                    TimeIn: temp_timein,
                    TimeOut: temp_timeout
                };
                if (date && name) {
                    const parsedDate = excelDateToJSDate(date);
                    if (events[parsedDate])
                {
                    events[parsedDate].push(event);
                }
                   else
                   {
                    events[parsedDate]=[event];
                   }
                }
            }
            console.log(events);

            localStorage.setItem('calendarEvents', JSON.stringify(events));
            alert('Events uploaded successfully!');

            console.log('Current localStorage:', localStorage.getItem('calendarEvents'));
            
        };
       
        reader.readAsArrayBuffer(fileUpload);
    }
</script>
</body>
</html>
